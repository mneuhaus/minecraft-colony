<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAS Timeline - Debug Stream</title>
    <style>
        /* Design Tokens from STYLEGUIDE */
        :root {
            --bg: #1C1C1C;
            --panel: #202020;
            --hover: #2A2A2A;
            --border: #2E2E2E;
            --fg: #EAEAEA;
            --fg-2: #B3B3B3;
            --muted: #7A7A7A;
            --accent: #E96D2F;
            --code-bg: #181818;
            /* Semantic (subtle) */
            --ok: #1FA97B;
            --warn: #D18D1E;
            --fail: #CC4B4B;
            /* Lane accents (subtle grayscale) */
            --intent: #8B8B8B;
            --plan: #9A9A9A;
            --step: #A0A0A0;
            --tool: #B0B0B0;
            --safety: #C2A64A;
            --chat-in: #A8A8A8;
            --chat-out: #A8A8A8;
            --system: #8A8A8A;
            /* Lane tints (alpha overlays) */
            --intent-tint: rgba(139,139,139,0.14);
            --plan-tint: rgba(154,154,154,0.14);
            --step-tint: rgba(160,160,160,0.14);
            --tool-tint: rgba(176,176,176,0.14);
            --safety-tint: rgba(194,166,74,0.16);
            --chat-tint: rgba(168,168,168,0.12);
            --system-tint: rgba(138,138,138,0.14);
            /* Stronger chat tints for full-card background */
            --chat-in-strong: rgba(233,109,47,0.16);
            --chat-out-strong: rgba(181,206,168,0.14);
            --skill-tint: rgba(154,154,154,0.16);
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 15px;
            line-height: 1.6;
        }
        a { color: var(--fg); opacity: 0.85; text-decoration: none; transition: opacity .15s ease-in-out; }
        a:hover { opacity: 1; text-decoration: underline; }

        /* Main Layout */
        .app { display: grid; grid-template-columns: 280px 1fr; height: 100vh; }

        /* Sidebar */
        .app__sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 16px; display: flex; flex-direction: column; gap: 16px; height: 100vh; overflow-y: auto; }

        .app__header {
            font-size: 18px;
            font-weight: 600;
            color: #F2F2F2;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Agent List */
        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .agent-list__item {
            padding: 10px 12px;
            border-radius: 12px;
            background: var(--panel);
            cursor: pointer;
            border: 1px solid var(--border);
            transition: background .15s ease-in-out, outline .15s ease-in-out;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        .agent-list__item:hover { background: var(--hover); }
        .agent-list__item:focus-visible { outline: 1px solid var(--accent); }
        .agent-list__item[aria-selected="true"] { outline: 1px solid var(--accent); background: var(--hover); }

        .agent-list__meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-list__name {
            font-weight: 500;
        }

        .agent-list__badges {
            display: flex;
            gap: 4px;
        }

        .agent-list__badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 600;
            background: linear-gradient(to bottom, #2B2B2B, #262626);
            color: #CFCFCF;
            border: 1px solid var(--border);
        }
        .agent-list__badge--idle { color: #CFCFCF; }
        .agent-list__badge--running { color: #CFCFCF; border-color: #365246; }
        .agent-list__badge--paused { color: #E0C68A; border-color: #5E4A1A; }
        .agent-list__badge--error { color: #E3A2A2; border-color: #5A2A2A; }

        /* Filters */
        .agent-list__filters {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .filter-chip { padding: 6px 10px; border-radius: 8px; background: #2A2A2A; border: 1px solid var(--border); cursor: pointer; font-size: 12px; color: var(--fg); transition: background .15s ease-in-out, color .15s ease-in-out, border-color .15s ease-in-out; }
        .filter-chip:hover { background: #333333; }
        .filter-chip:focus-visible { outline: 1px solid var(--accent); }
        .filter-chip--active { background: var(--hover); border-color: var(--accent); }

        /* Timeline Main Area */
        .app__main { display: flex; flex-direction: column; overflow: hidden; height: 100vh; }

        /* Timeline Header */
        .timeline__header {
            padding: 16px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .timeline__filters {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .timeline__search { flex: 1; min-width: 200px; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--fg); transition: border-color .15s ease-in-out; }
        .timeline__search:focus-visible { outline: none; border-color: var(--accent); }

        /* Minimal scrollbars */
        *::-webkit-scrollbar { width: 10px; height: 10px; }
        *::-webkit-scrollbar-track { background: var(--bg); }
        *::-webkit-scrollbar-thumb { background: #3A3A3A; border-radius: 8px; }
        *::-webkit-scrollbar-thumb:hover { background: #4A4A4A; }

        /* Timeline Stream */
        .timeline { flex: 1; overflow-y: auto; padding: 10px; }

        .timeline__list { display: flex; flex-direction: column; gap: 6px; }

        /* Timeline Item (Chat-style cards) */
        .tl-item { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px; position: relative; transition: background .15s ease-in-out, outline .15s ease-in-out; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .tl-item:hover { background: var(--hover); }
        .tl-item--selected { outline: 1px solid var(--accent); }

        /* Item type backgrounds (tinted to match styleguide) */
        .tl-item--intent { background-image: linear-gradient(0deg, var(--intent-tint), var(--intent-tint)); }
        .tl-item--plan { background-image: linear-gradient(0deg, var(--plan-tint), var(--plan-tint)); }
        .tl-item--step { background-image: linear-gradient(0deg, var(--step-tint), var(--step-tint)); }
        .tl-item--tool { background-image: linear-gradient(0deg, var(--tool-tint), var(--tool-tint)); }
        .tl-item--skill { background-image: linear-gradient(0deg, var(--skill-tint), var(--skill-tint)); }
        .tl-item--safety { background-image: linear-gradient(0deg, var(--safety-tint), var(--safety-tint)); }
        .tl-item--chat-in { background-image: linear-gradient(0deg, var(--chat-in-strong), var(--chat-in-strong)); }
        .tl-item--chat-out { background-image: linear-gradient(0deg, var(--chat-out-strong), var(--chat-out-strong)); }
        .tl-item--system { background-image: linear-gradient(0deg, var(--system-tint), var(--system-tint)); }
        .tl-item--job { background-image: linear-gradient(0deg, rgba(233,109,47,0.10), rgba(233,109,47,0.10)); }

        /* Outcome modifiers */
        .tl-item--ok .tl-item__outcome { color: var(--ok); }
        .tl-item--warn .tl-item__outcome { color: var(--warn); }
        .tl-item--fail .tl-item__outcome { color: var(--fail); }

        /* Item structure */
        .tl-item__header { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted); margin-bottom: 4px; }

        .tl-item__meta { display: flex; gap: 8px; align-items: center; }
        .tl-time { color: var(--muted); font-size: 11px; }

        .tl-item__title { font-weight: 600; margin-bottom: 4px; font-size: 15px; color: #F2F2F2; }

        .tl-item__body { font-size: 13px; color: var(--fg); margin-bottom: 4px; }

        .tl-item__footer { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }

        /* Badges */
        .tl-badge { font-size: 10px; padding: 2px 8px; border-radius: 999px; background: linear-gradient(to bottom, #2B2B2B, #262626); border: 1px solid var(--border); font-weight: 600; color: #CFCFCF; }
        .tl-badge--phase { border-color: var(--accent); color: var(--fg); }
        .tl-badge--job { border-color: #3A3A3A; }
        .tl-badge--duration { background: transparent; color: var(--muted); border: 1px solid var(--border); border-radius: 6px; }
        .tl-badge--hazard { background: var(--safety); color: #000; border: none; }
        .tl-badge--usage { background: transparent; color: var(--muted); border: 1px solid var(--border); border-radius: 6px; }
        .tl-badge--burst { background: #2D2D2D; border-color: #3A3A3A; color: #DCDCDC; }

        /* Thread/Job grouping */
        .tl-thread {
            margin-left: 20px;
            border-left: 2px solid var(--border);
            padding-left: 12px;
        }

        .tl-thread-header { font-weight: 600; padding: 6px 10px; background: var(--hover); border-radius: 8px; margin-bottom: 6px; font-size: 13px; }

        /* Todo list styling for TodoWrite tool */
        .tl-todos { list-style: none; padding-left: 0; margin: 0; display: flex; flex-direction: column; gap: 6px; }
        .tl-todo { display: flex; align-items: flex-start; gap: 8px; }
        .tl-todo__box { width: 14px; height: 14px; border: 1px solid #EAEAEA; border-radius: 3px; background: #EAEAEA; position: relative; margin-top: 2px; }
        .tl-todo__box--done { background: #2F4A3C; border-color: #365246; }
        .tl-todo__check { position: absolute; left: 2px; top: -1px; color: var(--fg); font-size: 14px; line-height: 14px; }
        .tl-todo__content { color: var(--fg); }

        /* Chat bubbles */
        .tl-item--chat-in .tl-item__body,
        .tl-item--chat-out .tl-item__body { padding: 2px 0; border-radius: 0; display: block; }

        /* Tool block: terminal-like style */
        .tool-view { display: flex; flex-direction: column; gap: 6px; }
        .tool-head { font-family: 'JetBrains Mono','Monaco','Menlo',monospace; font-size: 13px; color: var(--fg-2); display: flex; align-items: center; gap: 8px; }
        .tool-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .tool-dot--ok { background: var(--ok); }
        .tool-dot--fail { background: var(--fail); }
        .tool-proc { font-weight: 700; color: #F2F2F2; }
        .tool-cmd { color: var(--fg-2); }
        .tool-arrow { color: var(--muted); font-family: 'JetBrains Mono','Monaco','Menlo',monospace; }
        .tool-output { background: var(--code-bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-family: 'JetBrains Mono','Monaco','Menlo',monospace; font-size: 12px; color: #CCCCCC; white-space: pre-wrap; overflow-x: auto; }
        .tool-more { color: var(--muted); font-size: 12px; cursor: pointer; user-select: none; }
        .tl-kv { display: flex; gap: 14px; flex-wrap: wrap; align-items: center; }
        .tl-kv__key { color: var(--muted); }
        .tl-kv__val { color: var(--fg); }

        /* Align chat: player input (chat-in) on right, bot output on left */
        /* Align: user on right, bot on left; bubble stays transparent so tint is applied to the card */
        .tl-item--chat-in .tl-item__body { background: transparent; margin: 2px 0; }
        .tl-item--chat-out .tl-item__body { background: transparent; margin: 2px 0; }

        /* Sidebar inventory preview */
        .agent-list__inventory { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 7px; }
        .agent-list__inv-item { position: relative; width: 30px; height: 30px; border-radius: 8px; background: #2A2A2A; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .agent-list__inv-item img { width: 22px; height: 22px; image-rendering: pixelated; }
        .agent-list__inv-badge { position: absolute; right: -5px; top: -5px; background: #2B2B2B; color: #CFCFCF; border: 1px solid var(--border); border-radius: 999px; padding: 0 4px; font-size: 10px; line-height: 16px; height: 16px; min-width: 16px; text-align: center; }

        /* Sidebar todos */
        .agent-list__todos { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
        .agent-list__todo { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--fg-2); }
        .agent-list__todo-box { width: 12px; height: 12px; border: 1px solid #EAEAEA; background: #EAEAEA; border-radius: 3px; }
        .agent-list__todo-box--done { background: #2F4A3C; border-color: #365246; position: relative; }
        .agent-list__todo-check { position: relative; left: -11px; top: 0px; color: #EAEAEA; font-size: 12px; }
        .agent-list__todo-progress { margin-top: 4px; font-size: 11px; color: var(--muted); }

        /* Inspector Drawer */
        .inspector {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--panel);
            border-left: 1px solid var(--border);
            transition: right 0.3s ease-in-out;
            z-index: 100;
            overflow-y: auto;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        .inspector--open {
            right: 0;
        }

        .inspector__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .inspector__close {
            background: none;
            border: none;
            color: var(--fg);
            cursor: pointer;
            font-size: 20px;
        }

        .inspector__section {
            margin-bottom: 16px;
        }

        .inspector__section-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
        }

        .inspector__json { background: var(--code-bg); padding: 8px; border-radius: 8px; font-family: 'JetBrains Mono','Monaco','Menlo',monospace; font-size: 12px; overflow-x: auto; color: #CCCCCC; }

        /* Gap marker */
        .tl-gap {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            padding: 8px;
            font-style: italic;
        }

        /* Action buttons */
        .tl-actions { display: flex; gap: 6px; }
        .tl-action { padding: 6px 10px; font-size: 12px; background: #2A2A2A; border: 1px solid var(--border); border-radius: 8px; color: var(--fg); cursor: pointer; transition: background .15s ease-in-out, border-color .15s ease-in-out; }
        .tl-action:hover { background: #333333; }
        .tl-action:focus-visible { outline: 1px solid var(--accent); }

        /* Collapsible macro */
        .tl-macro-toggle {
            cursor: pointer;
            user-select: none;
        }

        .tl-macro-content {
            margin-top: 8px;
            padding-left: 16px;
            border-left: 2px solid var(--border);
        }

        .tl-macro-content--collapsed {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar with bot list -->
        <aside class="app__sidebar">
            <div class="app__header">
                <span>ðŸ¤–</span>
                <span>MAS Timeline</span>
            </div>
            
            <!-- Bot selection -->
            <div class="agent-list__filters">
                <button class="filter-chip filter-chip--active" data-view="single">This Bot</button>
                <button class="filter-chip" data-view="all">All Bots</button>
            </div>
            
            <!-- Bot list -->
            <div id="agentList" class="agent-list">
                <!-- Populated by JS -->
            </div>
            
            <!-- Quick filters -->
            <div class="agent-list__filters">
                <button class="filter-chip" data-filter="running">Running</button>
                <button class="filter-chip" data-filter="paused">Paused</button>
                <button class="filter-chip" data-filter="hazard">Hazard</button>
                <button class="filter-chip" data-filter="jobs">Has Jobs</button>
            </div>
        </aside>

        <!-- Main timeline area -->
        <main class="app__main">
            <!-- Timeline header with filters -->
            <header class="timeline__header">
                <div class="timeline__filters">
                    <button class="filter-chip filter-chip--active" data-type="all">All</button>
                    <button class="filter-chip" data-type="intent">Intent</button>
                    <button class="filter-chip" data-type="plan">Plan</button>
                    <button class="filter-chip" data-type="step">Step</button>
                    <button class="filter-chip" data-type="tool">Tool</button>
                    <button class="filter-chip" data-type="chat">Chat</button>
                    <button class="filter-chip" data-type="safety">Safety</button>
                </div>
                
                <div class="timeline__filters">
                    <button class="filter-chip" data-outcome="ok">âœ“ OK</button>
                    <button class="filter-chip" data-outcome="warn">âš  Warn</button>
                    <button class="filter-chip" data-outcome="fail">âœ— Fail</button>
                </div>
                
                <input type="text" class="timeline__search" placeholder="Search tools, ops, blocks, jobs...">
                <button class="filter-chip" id="loadOlderBtn" title="Load older events">Load older</button>
            </header>

            <!-- Timeline stream -->
            <div class="timeline">
                <div id="timelineList" class="timeline__list">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>
        </main>

        <!-- Inspector drawer -->
        <aside id="inspector" class="inspector">
            <div class="inspector__header">
                <h3 id="inspectorTitle">Inspector</h3>
                <button class="inspector__close" onclick="closeInspector()">Ã—</button>
            </div>
            <div id="inspectorContent">
                <!-- Inspector content populated dynamically -->
            </div>
        </aside>
    </div>

    <!-- Markdown renderer + sanitizer for thinking blocks -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.4/dist/purify.min.js"></script>
    <!-- YAML + Syntax highlighting for Inspector -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark-dimmed.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/yaml.min.js"></script>
    <script>window.hljs && window.hljs.registerLanguage('yaml', window.hljsYAML || window.hljs.getLanguage('yaml'));</script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="timeline.js"></script>
    <script>
        // Keyboard shortcuts: J/K navigate, Enter open inspector, / focus search
        document.addEventListener('keydown', (e) => {
            const tl = window.masTimeline;
            if (!tl) return;
            if (e.key === '/' && !e.metaKey && !e.ctrlKey) {
                const search = document.querySelector('.timeline__search');
                if (search) { e.preventDefault(); search.focus(); }
            }
            if (['j','k','J','K'].includes(e.key)) {
                e.preventDefault();
                tl.navigateSelection(e.key.toLowerCase() === 'j' ? 1 : -1);
            }
            if (e.key === 'Enter') {
                tl.openSelectedInspector();
            }
        });
    </script>
</body>
</html>
