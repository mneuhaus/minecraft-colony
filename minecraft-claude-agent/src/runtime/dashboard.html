<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Colony Dashboard</title>
    <style>
      :root { --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa0a6; --panel:#161a22; --accent:#7c83ff; --ok:#10b981; --warn:#f59e0b; --fail:#ef4444; }
      *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
      .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
      .app__sidebar{background:#0b0e13;border-right:1px solid #1e2430;padding:16px;display:flex;flex-direction:column}
      .app__header{color:#fff;margin-bottom:12px;font-size:18px}
      .agent-list{display:flex;flex-direction:column;gap:6px}
      .agent-list__item{padding:10px 12px;border-radius:8px;background:var(--panel);cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:1px solid #202636}
      .agent-list__item[aria-selected="true"]{outline:2px solid var(--accent)}
      .agent-list__badge{font-size:11px;padding:2px 8px;border-radius:999px;color:#fff}
      .badge--ok{background:var(--ok)} .badge--warn{background:var(--warn)} .badge--fail{background:var(--fail)} .badge--off{background:#6b7280}
      .app__main{padding:16px}
      .agent__header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
      .tabs{display:flex;flex-direction:column}
      .tabs__nav{display:flex;gap:6px;margin-bottom:8px}
      .tabs__nav-item{background:var(--panel);border:1px solid #202636;color:var(--fg);padding:8px 12px;border-radius:8px;cursor:pointer}
      .tabs__nav-item[aria-selected="true"]{outline:2px solid var(--accent)}
      .tabs__panel{display:none}
      .tabs__panel[aria-hidden="false"]{display:block}
      .overview__grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
      .card{background:var(--panel);border:1px solid #202636;border-radius:10px;padding:12px}
      .chat__stream{display:flex;flex-direction:column-reverse;gap:8px;max-height:60vh;overflow:auto;background:var(--panel);border:1px solid #202636;border-radius:10px;padding:12px}
      .chat-msg{display:flex;gap:8px}
      .chat-msg .who{min-width:64px;color:var(--muted)}
      .chat-msg--in .who{color:#7dd3fc}
      .chat-msg--out .who{color:#a78bfa}
      .chat-msg--system .who{color:#94a3b8}
      .chat-msg--tool .who{color:#34d399}
      .chat-msg--thinking .who{color:#f59e0b}
      .jobs__table{width:100%;border-collapse:collapse}
      .jobs__table th,.jobs__table td{border-bottom:1px solid #202636;padding:8px;text-align:left}
      .jobs__controls button{margin-right:6px}
    </style>
</head>
<body>
    <div class="app">
      <aside class="app__sidebar">
        <div class="app__header">ðŸ¤– Agents</div>
        <div id="agentList" class="agent-list"></div>
      </aside>
      <main class="app__main">
        <div class="agent__header">
          <div id="agentTitle">Select an agent</div>
          <div id="agentBadges"></div>
        </div>
        <div class="tabs">
          <div class="tabs__nav">
            <button class="tabs__nav-item" data-tab="overview" aria-selected="true">Overview</button>
            <button class="tabs__nav-item" data-tab="chat">Chat</button>
            <button class="tabs__nav-item" data-tab="jobs">Jobs</button>
          </div>
          <section id="tab-overview" class="tabs__panel" aria-hidden="false">
            <div class="overview__grid">
              <div class="card"><div id="statusLine">Status: -</div></div>
              <div class="card"><div id="positionLine">Pos: -</div></div>
              <div class="card"><div id="inventoryLine">Inventory: -</div></div>
            </div>
          </section>
          <section id="tab-chat" class="tabs__panel" aria-hidden="true">
            <div id="chatStream" class="chat__stream"></div>
          </section>
          <section id="tab-jobs" class="tabs__panel" aria-hidden="true">
            <table class="jobs__table">
              <thead><tr><th>ID</th><th>Kind</th><th>Phase</th><th>State</th><th>Updated</th><th>Controls</th></tr></thead>
              <tbody id="jobsBody"></tbody>
            </table>
            <div id="jobSteps" class="card" style="margin-top:10px;"></div>
          </section>
        </div>
      </main>
    </div>

    <script>
      const agentList = document.getElementById('agentList');
      const agentTitle = document.getElementById('agentTitle');
      const jobsBody = document.getElementById('jobsBody');
      const jobSteps = document.getElementById('jobSteps');
      const chatStream = document.getElementById('chatStream');
      let activeBot = null;
      let ws;

      document.querySelectorAll('.tabs__nav-item').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tabs__nav-item').forEach(b=>b.setAttribute('aria-selected','false'));
          btn.setAttribute('aria-selected','true');
          const tab = btn.dataset.tab;
          document.querySelectorAll('.tabs__panel').forEach(p => p.setAttribute('aria-hidden','true'));
          document.getElementById(`tab-${tab}`).setAttribute('aria-hidden','false');
          if (tab==='chat') loadActivity();
          if (tab==='jobs') loadJobs();
          if (tab==='overview') loadOverview();
        });
      });

      async function loadBots(){
        const res = await fetch('/api/bots');
        const bots = await res.json();
        agentList.innerHTML='';
        bots.forEach(b=>{
          const li = document.createElement('div');
          li.className='agent-list__item';
          li.innerHTML = `<div>${b.name} <span style="color:var(--muted)">(${b.username})</span></div>`+
                         `<span class="agent-list__badge ${badgeClass(b)}">${b.connectionStatus||'unknown'}</span>`;
          li.addEventListener('click',()=>selectBot(b.name));
          if (activeBot===b.name) li.setAttribute('aria-selected','true');
          agentList.appendChild(li);
        });
        if (!activeBot && bots.length) selectBot(bots[0].name);
      }

      function badgeClass(b){
        if (b.connectionStatus==='connected') return 'badge--ok';
        if (b.connectionStatus==='connecting') return 'badge--warn';
        if (b.connectionStatus==='error') return 'badge--fail';
        return 'badge--off';
      }

      async function selectBot(name){
        activeBot = name;
        agentTitle.textContent = name;
        document.querySelectorAll('.agent-list__item').forEach(n=>n.setAttribute('aria-selected','false'));
        Array.from(agentList.children).forEach((n)=>{ if (n.textContent.includes(name)) n.setAttribute('aria-selected','true'); });
        loadOverview();
        loadActivity();
        loadJobs();
        ensureWs();
      }

      async function loadOverview(){
        if (!activeBot) return;
        const res = await fetch(`/api/bots/${activeBot}`);
        const s = await res.json();
        document.getElementById('statusLine').textContent = `Status: ${s.connectionStatus}`;
        const pos = s.position? `(${s.position.x},${s.position.y},${s.position.z})` : '-';
        document.getElementById('positionLine').textContent = `Pos: ${pos}`;
        const inv = (s.inventory||[]).slice(0,6).map(i=>`${i.name}Ã—${i.count}`).join(', ');
        document.getElementById('inventoryLine').textContent = `Inventory: ${inv||'-'}`;
      }

      async function loadActivity(){
        if (!activeBot) return;
        try{
          const res = await fetch(`/api/activity/${activeBot}`);
          if (!res.ok) { chatStream.innerHTML = '<div class="muted">No activity yet</div>'; return; }
          const items = await res.json();
          renderActivity(items);
        }catch{ /* ignore */ }
      }

      function renderActivity(items){
        chatStream.innerHTML = '';
        items.forEach(it=>{
          const div = document.createElement('div');
          const cls = it.type==='tool' ? 'chat-msg--tool' : it.type==='thinking' ? 'chat-msg--thinking' : (it.role==='player'?'chat-msg--in': it.role==='bot'?'chat-msg--out':'chat-msg--system');
          div.className = `chat-msg ${cls}`;
          const who = it.speaker || it.type;
          const text = (typeof it.message==='string') ? it.message : JSON.stringify(it.message);
          div.innerHTML = `<div class="who">${who}</div><div class="msg">${escapeHtml(text)}</div>`;
          chatStream.appendChild(div);
        });
      }

      async function loadJobs(){
        const res = await fetch('/api/jobs');
        const jobs = await res.json();
        const filtered = jobs.filter(j=>!activeBot || j.bot_id===activeBot);
        jobsBody.innerHTML = filtered.map(j=>
          `<tr data-id="${j.id}"><td>${j.id.slice(0,8)}</td><td>${j.kind}</td><td>${j.phase}</td><td>${j.state}</td><td>${new Date(j.updated_at).toLocaleTimeString()}</td>`+
          `<td class="jobs__controls">`+
          `<button onclick="jobCtl('${j.id}','pause')">Pause</button>`+
          `<button onclick="jobCtl('${j.id}','resume')">Resume</button>`+
          `<button onclick="jobCtl('${j.id}','cancel')">Cancel</button>`+
          `</td></tr>`
        ).join('');
      }

      async function jobCtl(id,action){
        await fetch(`/api/jobs/${id}/${action}`,{method:'POST'});
        await loadJobs();
        await loadSteps(id);
      }

      async function loadSteps(id){
        const res = await fetch(`/api/jobs/${id}/steps`);
        const steps = await res.json();
        jobSteps.innerHTML = `<b>Steps for ${id.slice(0,8)}</b><pre>${steps.map(s=>`${s.i}. ${s.op} (${s.outcome}) ${s.ms}ms`).join('\n')}</pre>`;
      }

      function ensureWs(){
        if (ws && ws.readyState===1) return;
        ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws');
        ws.onmessage = (ev)=>{
          try{
            const data = JSON.parse(ev.data);
            const arr = Array.isArray(data)?data:[data];
            arr.forEach(msg=>{
              if (msg.type==='job_update') loadJobs();
              if (msg.type==='job_step'){
                // if step belongs to active bot, refresh
                loadJobs();
                loadSteps(msg.job_id);
              }
            });
          }catch{}
        };
      }

      function escapeHtml(str){
        return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
      }

      // Initial
      loadBots();
      setInterval(loadBots, 5000);
    </script>
                renderBots(bots);
                document.getElementById('error-container').innerHTML = '';
            } catch (error) {
                document.getElementById('error-container').innerHTML =
                    `<div class="error-message">Error loading bots: ${error.message}</div>`;
                console.error('Error fetching bots:', error);
            }
        }

        function renderBots(bots) {
            if (bots.length === 0) {
                document.getElementById('bots-container').innerHTML =
                    '<div class="loading">No bots configured</div>';
                return;
            }

            const html = bots.map(bot => `
                <div class="bot-card">
                    <div class="bot-header">
                        <div class="bot-name">${bot.name}</div>
                        <div class="status-badge status-${bot.connectionStatus}">
                            ${bot.connectionStatus}
                        </div>
                    </div>

                    <div class="bot-info">
                        <div class="info-item">
                            <div class="info-label">Health</div>
                            <div class="info-value">${bot.health || '?'}/20</div>
                            <div class="health-bar">
                                <div class="health-fill" style="width: ${(bot.health || 0) / 20 * 100}%"></div>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">Food</div>
                            <div class="info-value">${bot.food || '?'}/20</div>
                            <div class="food-bar">
                                <div class="food-fill" style="width: ${(bot.food || 0) / 20 * 100}%"></div>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">Position</div>
                            <div class="info-value">
                                ${bot.position ? `${bot.position.x}, ${bot.position.y}, ${bot.position.z}` : 'Unknown'}
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">Game Mode</div>
                            <div class="info-value">${bot.gameMode || 'Unknown'}</div>
                        </div>
                    </div>

                    ${bot.inventory && bot.inventory.length > 0 ? `
                        <div class="inventory-section">
                            <div class="inventory-title">Inventory (${bot.inventory.length} types)</div>
                            <div class="inventory-items">
                                ${bot.inventory.slice(0, 8).map(item => `
                                    <div class="inventory-item">
                                        <img class="item-icon" src="/api/texture/${item.name}"
                                             onerror="this.style.display='none'" alt="${item.name}">
                                        ${item.name} x${item.count}
                                    </div>
                                `).join('')}
                                ${bot.inventory.length > 8 ? '<div class="inventory-item">...</div>' : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${bot.viewerUrl ?
                        `<a href="${bot.viewerUrl}" target="_blank" class="viewer-link">
                            Open 3D Viewer
                        </a>` :
                        '<div class="no-viewer">No viewer available</div>'
                    }

                    ${bot.lastUpdate ? `
                        <div style="text-align: center; color: #666; font-size: 0.75em; margin-top: 10px;">
                            Last update: ${new Date(bot.lastUpdate).toLocaleTimeString()}
                            ${bot.timeSinceUpdate ? ` (${bot.timeSinceUpdate}s ago)` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('bots-container').innerHTML =
                `<div class="bots-grid">${html}</div>`;
        }

        // Initial fetch
        fetchBots();

        // Auto-refresh every 5 seconds
        setInterval(fetchBots, 5000);
    </script>
</body>
</html>
